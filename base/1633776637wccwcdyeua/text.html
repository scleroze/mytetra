<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://rc-master.ucoz.ru/publ/19-1-0-28"><span style=" text-decoration: underline; color:#0000ff;">http://rc-master.ucoz.ru/publ/19-1-0-28</span></a></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'verdana,arial,helvetica'; font-size:12pt; font-weight:600; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:12pt; font-weight:600; color:#000000; background-color:#ffffff;">Декодер PPM с RC-аппаратуры на Arduino</span><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; color:#000000; background-color:#ffffff;"><br /><br /></span></p>
<p align="justify" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; font-weight:600; color:#000000;">Задача:</span><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; color:#000000;"><br />   Имеется пульт системы радиоуправления и/или приемник с выходом CPPM. Хотим получить массив значений ширины импульса для каждого канала.<br /><br /></span><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; font-weight:600; color:#000000;">Использованное оборудование:</span><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; color:#000000;"><br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Система р/у - </span><a href="http://www.parkflyer.ru/57287/product/8992/"><span style=" font-size:10pt; text-decoration: underline; color:#57627f;">Турнига 9х</span></a><span style=" font-size:10pt;"> или любая другая JR-совместимая.</span></li>
<li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.parkflyer.ru/57287/product/537670/"><span style=" font-size:10pt; text-decoration: underline; color:#57627f;">Шилд</span></a><span style=" font-size:10pt;"> - нужен только для удобства подключения. Можете обойтись и без него, пожертвовав удобством.</span></li>
<li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">МК - клон Arduino на базе ATmega168(вполне подойдет и </span><a href="http://www.parkflyer.ru/57287/product/512191/"><span style=" font-size:10pt; text-decoration: underline; color:#57627f;">такая плата</span></a><span style=" font-size:10pt;"> или любой другой клон).</span></li>
<li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">ВЧ-модуль </span><a href="http://www.parkflyer.ru/57287/product/103811/"><span style=" font-size:10pt; text-decoration: underline; color:#57627f;">FrSky</span></a><span style=" font-size:10pt;"><br /></span></li>
<li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Приемник </span><a href="http://www.parkflyer.ru/57287/product/185814/"><span style=" font-size:10pt; text-decoration: underline; color:#57627f;">FrSky D8R-XP</span></a><span style=" font-size:10pt;"><br /></span></li></ul>
<p align="justify" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; font-weight:600; color:#000000;">ПО:</span><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; color:#000000;"><br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://arduino.ru/Arduino_environment"><span style=" font-size:10pt; text-decoration: underline; color:#57627f;">Arduino IDE 1.0.2</span></a></li>
<li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Библиотека </span><a href="http://playground.arduino.cc/Main/PinChangeInt"><span style=" font-size:10pt; text-decoration: underline; color:#57627f;">PinChangeInt</span></a><span style=" font-size:10pt;"> для удобства работы с прерываниями. Я пробовал и без нее - результат тот же, а с ней нагляднее. Потеря памяти меня устроила.</span></li></ul>
<p align="justify" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; font-weight:600; color:#000000;">Подключение:<br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1633776635ey0jkm2hbw.png" /><span style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;"><br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Питание МК берем с USB.</span></li>
<li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">На приемнике замыкаем перемычкой контакты S третьего и четвертого каналов. Тогда на первом канале он выдает CPPM, а на втором RSSI. Подключение Вашего приемника может отличаться (см. документацию на приемник). Мой был не перепрошитый, обычный, только что из магазина… Длинна пакета 18мс. В случае подключения к передатчику соединяем «землю» и сигнал с PPM и GND согласно рисунку.</span></li></ul>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1633776635es0zofqdz9.png" /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;" align="justify" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:10pt;">Первый канал приемник соединяем с пятым пином МК при помощи обычного 3х-шнура (как у сервы). Опять же удобство шилда - без каких бы то ни было проблем приемник получает питание с МК.</span></li></ul>
<p align="justify" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; color:#000000;"><br />Все провода стандартные и ничего паять и обжимать не надо - спасибо шилду.<br /><br /></span><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; font-weight:600; color:#000000;">Алгоритм:</span><span style=" font-family:'verdana,arial,helvetica'; font-size:10pt; color:#000000;"><br />Вешаем на входной пин прерывание на изменение уровня.<br />В прерывании первым делом проверяем состояние пина.  Все действия выполняем только для состояния 0: Вычисляем разницу во времени с предыдущим импульсом. Если она больше 3500 мкс (синхропауза), то сохраняем номер текущего канала как количество каналов и сбрасываем номер текущего канала в 0. Иначе полученную разницу записываем в текущий канал и переходим к следующему каналу.<br />Вывод результата сделан на комп через последовательный порт. Туда же по ходу дела выводим RSSI с приемника.<br /><br /></span><span style=" font-family:'verdana,arial,helvetica'; font-size:9pt; font-weight:600; color:#000000;">Скетч:</span><span style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;"> </span><a href="http://rc-master.ucoz.ru/Arduino/ppm_read/ppm_read.rar"><span style=" font-family:'verdana,arial,helvetica'; font-size:9pt; text-decoration: underline; color:#57627f;">скачать</span></a><span style=" font-family:'verdana,arial,helvetica'; font-size:9pt; color:#000000;"><br /><br />#include &lt;PinChangeInt.h&gt;<br /><br />#define PPM_PIN 5<br />#define MAX_PPM_CHANNELS 25<br /><br />volatile uint16_t temp_time;<br />volatile uint16_t up_time;<br />volatile uint16_t d_time;<br /><br />volatile uint16_t ChannelsCount;<br />volatile uint16_t Channel[MAX_PPM_CHANNELS];<br />volatile uint8_t Curr_Channel;<br /><br />void setup()<br />{<br />  digitalWrite(19, HIGH); // включить резистор на выводе аналогового входа 0<br />  pinMode(13, OUTPUT);<br />  ChannelsCount==0xff;<br />  Curr_Channel=0;<br />  Serial.begin(9600);<br />  Serial.println(&quot;Start&quot;);<br />  TCCR1B   =   0;   //stop timer<br />  TCCR1A   =   0;<br />  TCNT1   =    0;   //setup<br />  TCCR1A   =   0;  <br />  up_time = 0;<br />  TCCR1B   =   0&lt;&lt;CS12 | 1&lt;&lt;CS11 | 0&lt;&lt;CS10;//0x1A; //start timer with 1/8<br />  PCintPort::attachInterrupt(PPM_PIN, CalcPPM, CHANGE);<br />}<br /><br />uint16_t Rssi;<br />void loop()<br />{<br />  delay(50);<br />  Rssi = analogRead(5);<br />  delay(50);<br />  Serial.println(&quot;RSSI=&quot;+String(Rssi));<br />  Serial.println(&quot;Channels=&quot;+String(ChannelsCount));<br />  for(uint8_t i=0;i&lt;ChannelsCount;i++)<br />    Serial.println(&quot;Channel[=&quot;+String(i)+&quot;]=&quot;+String(Channel[i]));<br />  digitalWrite(13, !digitalRead(13));<br /> <br />}<br /><br />void CalcPPM()<br />{<br />  temp_time = TCNT1;<br />  if (!PCintPort::pinState)<br />  {<br />    if (up_time&gt;temp_time) d_time=(0xffff-up_time+temp_time)&gt;&gt;1;<br />    d_time = (temp_time-up_time)&gt;&gt;1;<br />    up_time = temp_time;<br />    if (d_time&gt;3500)<br />    {<br />      //Sync<br />      ChannelsCount=Curr_Channel;<br />      Curr_Channel = 0;<br />    }<br />    else<br />    {<br />      //Channel<br />    Channel[Curr_Channel]=d_time;<br />    Curr_Channel++;<br />    }<br />  }<br /> <br />}</span></p></body></html>